---

- name: NOMAD | Ensure nomad group
  group:
    name: "{{ nomad_group }}"
    system: yes
    state: present

- name: NOMAD | Ensure nomad user
  user:
    name: "{{ nomad_user }}"
    group: "{{ nomad_group }}"
    system: yes
    shell: /usr/sbin/nologin
    createhome: no

- name: NOMAD | Check nomad version
  command: "{{ nomad_exec_name }} --version"
  register: nomad_check
  changed_when: false
  ignore_errors: true

- block:
    - name: NOMAD | Be sure hashicorp deb key is present
      apt_key:
        url: "{{ nomad_deb_key }}"
        state: present
    - name: NOMAD | Be sure nomad repo packages configured (deb)
      apt_repository:
        repo: "{{ nomad_deb_repo }}"
        state: present
        filename: 'postgresqldotorg'
    - name: NOMAD | Be sure nomad package is installed (apt)
      apt:
        name: "{{ nomad_package }}"
        state: present
        update_cache: true
  when: nomad_force_reinstall or nomad_check is failed or nomad_version
